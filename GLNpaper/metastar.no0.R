##----                    R-Script for piglet ileal microbiota
#                                METASTATS ANALYSIS
#       Code written by Dr. Tim Johnson, Purdue University, Dept. Of Animal Science

#install the fdrtool set of scripts. You only need to do this once on your machine. This is why I have it commented out
#install.packages('fdrtool')

# FUNCTION DEFINITION IF YOU WANT TO BE FANCY
#get_fdr_cor <- function(){

###siempre mantener el codigo reindent 
  #YOUR DATA NEED TO BE CONTAINED IN A DIRECTORY (which you set as the working directory)
  #WHICH CONTAINS YOUR TAXONOMY FILE AND THEN SUBDIRECTORY(IES) WITH THE UNCORRECTED METASTATS OUTPUTS FROM MOTHUR
  #IF IT IS ARRANGED LIKE THAT EVERYTHING WILL WORK OUT WITH THE MOST MINIMAL CHANGES TO THIS CODE.
  
  #EDIT THIS LINE TO DIRECT THE COMPUTER TO THE DIRECTORY WITH YOUR DATA
  #THIS IS THE ONLY LINE YOU NEED TO EDIT.
  library(fdrtool)
  working_dir <- '~/Desktop/eu/TesisGLN/new.glutamine/glutamine.list/No.D0/metasts.new/season/'
  working_dir <- '~/Desktop/eu/TesisGLN/new.glutamine/glutamine.list/No.D0/metasts.new/trt/'
  
  
  ##this block of code is to set up the output directories and read taxonomy file
  setwd(working_dir)
  output_dir <- paste0(working_dir, "/fdr.corrected_out1")
  
  
  directories <- list.dirs(path = ".", full.names = F)
  directories <- directories[-1]  
  
  #####when you try to read you taxonomy file, you should creat a folder with all the metasts result from mothur and not include the taxonomy file
  ##so you will have a folder with the mothur result and the taxonomy file in the metasts folder that you are using as a output_dir
  taxonomy_file <- list.files(recursive = F)
  taxonomy_file <- taxonomy_file[!file.info(taxonomy_file)$isdir]
  taxonomy <- read.table(file = taxonomy_file, header = T)
  taxonomy <- taxonomy[,-2]
  
  #This block of code uses the FDR correction to correct the metastats outputs and saves them
  dir.create(output_dir)
  for(i in 1:length(directories)){
    temp_files <- list.files(directories[i])
    print(paste("working on", directories[i]))
    dir.create(paste(output_dir,"/",directories[i], "_FDR.corrected", sep = ""))
    
    for(j in 1:length(temp_files)){
      metastat <- read.table(file = paste(directories[i],"/",temp_files[j], sep = ""), skip = 6, header = T)
      metastat <- metastat[which(rowSums(metastat[,2:7])>0|rowSums(metastat[,2:7])>NA),]
      if(nrow(metastat)>0){
        metastat$FDR.q.value <- p.adjust(metastat$p.value, method = "BH")
        metastat_tax <- merge(x = metastat, y = taxonomy, by = "OTU", all.x = TRUE)
        metastat_tax <- metastat_tax[order(metastat_tax[,9]), ]
        write.csv(metastat_tax, file = paste(output_dir, "/", directories[i], "_FDR.corrected", "/", temp_files[j], ".csv", sep = ""), row.names = F, quote = F)
      }
    }
  }
#}
